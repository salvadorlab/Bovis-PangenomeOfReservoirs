---
title: "MbovisInvestigatePCA"
author: "Noah Legall"
date: "10/8/2020"
output: pdf_document
---

As a reminder let's observe PC's 1 & 2 score plot:

```{r}
# I am curious how the clustering looks for the top 4 PC's. For the PCoA, we notice some strange clustering in the first 2 components, so I want to investigate if that is true as well. 
prab_pca <- prcomp(pa_transpose)
variance <- (prab_pca$sdev)^2
loadings <- prab_pca$rotation
rownames(loadings) <- colnames(pa_transpose)
scores <- prab_pca$x 


mbov_full_meta <- read.csv("../../../Documents/Mbovis_meta.csv", header = TRUE,stringsAsFactors = FALSE)
mbov_meta <- read.csv("/Users/noah_/Documents/filtered_isolate_list.csv",header = TRUE, stringsAsFactors = FALSE)
upd_mbov_meta <- mbov_meta %>% left_join(mbov_full_meta %>% select(Experiment,Instrument,Center.Name,Collection_Date), by = c("Sample" = "Experiment"))
mbov_meta <- upd_mbov_meta

scores <- as.data.frame(scores[,1:5])
scores$country <- mbov_meta$Country
scores$species <- mbov_meta$Species
scores$instrument <- mbov_meta$Instrument

ggplot(as.data.frame(scores),aes(x=PC1,y=PC2, fill = species, col = species)) +
  geom_point() +
  theme_minimal()
```

The closest possible solution I could find is from "Population Structure, Stratification, and Introgression of Human Structural Variation" where the 1st PC's are probably due to genome assembly differences.

To test is this is happening in my data, I will merge the assembly stats with the PCA data and do correlation testing specifically on PC2. I'll run a for loop to test every numeric column in the genome assembly statistics dataset. 

```{r}
library(dplyr)
scores$assembly <- rownames(scores)
assembly_stats <- read.csv("mbovis_transposed_report.csv",header = TRUE)
assembly_stats$assembly <- gsub(".scaffold","",assembly_stats$Ã¯..Assembly)
scores <- scores %>% left_join(assembly_stats, by="assembly")
```

```{r}
pc2 <- scores$PC1
#quick test
#cor.test(pc2,scores$N50,method = "pearson")

correlation_pvalue <- c()
genome_quality_stat <- c()
for(i in names(scores)){
  if(is.numeric(scores[,i])){
    PC2_corr <- cor.test(pc2,scores[,i])
    correlation_pvalue <- append(correlation_pvalue,PC2_corr$p.value)
    genome_quality_stat <- append(genome_quality_stat,i)
  }
  else{
    next()
  }
  
}

corr_values <- data.frame(genome_quality_stat,correlation_pvalue)
#order by the lowest p - value

head(corr_values[order(corr_values$correlation_pvalue),])
```

```{r}

ggplot(as.data.frame(scores),aes(x=PC1,y=X..N.s.per.100.kbp)) +
  geom_point() +
  theme_minimal()

ggplot(as.data.frame(scores),aes(x=PC1,y=GC....)) +
  geom_point() +
  theme_minimal()
```

Genome assembly can't particularly explain the patterns we see in PC2. And from my own perspective, PC1 can be explained by Genome Quality based on the correlations that match with PC1. whatever causes the clustering with PC2 probably has something to do with the bacterial preparation step, but I can't describe what it could be. 

